---
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  become: true

- name: Initialize install result tracking
  ansible.builtin.set_fact:
    install_success: []
    install_failed: []

- name: Install base apt packages (best effort)
  ansible.builtin.apt:
    name: "{{ item }}"
    state: present
  loop: "{{ apt_packages }}"
  loop_control:
    label: "{{ item }}"
  register: base_pkg_results
  failed_when: false
  become: true

- name: Track base apt package results
  ansible.builtin.set_fact:
    install_success: "{{ (install_success | default([], true))
      + (base_pkg_results.results | default([], true)
         | selectattr('rc','defined')
         | selectattr('rc','equalto',0)
         | map(attribute='item') | list) }}"
    install_failed: "{{ (install_failed | default([], true))
      + (base_pkg_results.results | default([], true)
         | selectattr('rc','defined')
         | rejectattr('rc','equalto',0)
         | map(attribute='item') | list) }}"

- name: Determine AWS CLI archive architecture
  ansible.builtin.set_fact:
    aws_cli_arch: "{{ 'aarch64' if ansible_architecture in ['aarch64', 'arm64'] else 'x86_64' }}"

- name: Download AWS CLI v2 bundle (best effort)
  ansible.builtin.get_url:
    url: "https://awscli.amazonaws.com/awscli-exe-linux-{{ aws_cli_arch }}.zip"
    dest: /tmp/awscliv2.zip
    mode: '0644'
  register: aws_cli_download
  failed_when: false

- name: Unpack AWS CLI v2 bundle (best effort)
  ansible.builtin.unarchive:
    src: /tmp/awscliv2.zip
    dest: /tmp
    remote_src: true
    creates: /tmp/aws
  register: aws_cli_unzip
  failed_when: false

- name: Install AWS CLI v2 (best effort)
  ansible.builtin.command: ./aws/install -i /usr/local/aws-cli -b /usr/local/bin
  args:
    chdir: /tmp
    creates: /usr/local/bin/aws
  register: aws_cli_install
  failed_when: false
  become: true

- name: Evaluate AWS CLI install status
  ansible.builtin.set_fact:
    aws_cli_failed: "{{ (aws_cli_download is failed) or (aws_cli_unzip is failed) or (aws_cli_install is failed) }}"

- name: Track AWS CLI install result
  ansible.builtin.set_fact:
    install_success: "{{ (install_success | default([])) + (aws_cli_failed | ternary([], ['awscli v2'])) }}"
    install_failed: "{{ (install_failed | default([])) + (aws_cli_failed | ternary(['awscli v2'], [])) }}"

- name: Enable Docker service
  ansible.builtin.service:
    name: docker
    state: started
    enabled: true
  become: true
  failed_when: false

- name: Add current user to docker group
  ansible.builtin.user:
    name: "{{ ansible_user_id }}"
    groups: docker
    append: true
  become: true
  failed_when: false

- name: Install lazydocker via snap (best effort)
  community.general.snap:
    name: lazydocker
    classic: true
    state: present
  register: lazydocker_result
  failed_when: false
  become: true

- name: Track lazydocker install result
  ansible.builtin.set_fact:
    install_success: "{{ (install_success | default([])) + ((lazydocker_result is failed) | ternary([], ['lazydocker (snap)'])) }}"
    install_failed: "{{ (install_failed | default([])) + ((lazydocker_result is failed) | ternary(['lazydocker (snap)'], [])) }}"

- name: Ensure apt keyrings directory exists
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  become: true

- name: Remove legacy VS Code repository file (to avoid signed-by conflicts)
  ansible.builtin.file:
    path: /etc/apt/sources.list.d/vscode.list
    state: absent
  become: true
  failed_when: false

- name: Remove legacy VS Code repository entry using /etc/apt/keyrings
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64,arm64,armhf signed-by=/etc/apt/keyrings/microsoft.gpg] https://packages.microsoft.com/repos/code stable main"
    filename: vscode
    state: absent
  become: true
  failed_when: false

- name: Remove legacy Microsoft keyring path
  ansible.builtin.file:
    path: /etc/apt/keyrings/microsoft.gpg
    state: absent
  become: true
  failed_when: false

- name: Add Microsoft GPG key (VS Code)
  ansible.builtin.apt_key:
    url: https://packages.microsoft.com/keys/microsoft.asc
    keyring: /usr/share/keyrings/microsoft.gpg
    state: present
  become: true
  failed_when: false

- name: Add VS Code apt repository
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64,arm64,armhf signed-by=/usr/share/keyrings/microsoft.gpg] https://packages.microsoft.com/repos/code stable main"
    filename: vscode
    state: present
  become: true
  failed_when: false

- name: Add Google Chrome GPG key
  ansible.builtin.apt_key:
    url: https://dl.google.com/linux/linux_signing_key.pub
    keyring: /etc/apt/keyrings/google-linux-signing-keyring.gpg
    state: present
  become: true
  failed_when: false

- name: Add Google Chrome apt repository
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/google-linux-signing-keyring.gpg] http://dl.google.com/linux/chrome/deb/ stable main"
    filename: google-chrome
    state: present
  become: true
  failed_when: false

- name: Add Slack GPG key
  ansible.builtin.apt_key:
    url: https://packagecloud.io/slacktechnologies/slack/gpgkey
    keyring: /etc/apt/keyrings/slack.gpg
    state: present
  become: true
  failed_when: false

- name: Add Slack apt repository
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/slack.gpg] https://packagecloud.io/slacktechnologies/slack/debian/ jessie main"
    filename: slack
    state: present
  become: true
  failed_when: false

- name: Remove legacy Spotify keyring path (if present)
  ansible.builtin.file:
    path: /etc/apt/keyrings/spotify.gpg
    state: absent
  become: true
  failed_when: false

- name: Add Spotify GPG key
  ansible.builtin.apt_key:
    url: https://download.spotify.com/debian/pubkey_0D811D58.gpg
    keyring: /usr/share/keyrings/spotify.gpg
    state: present
  become: true
  failed_when: false

- name: Add Spotify apt repository
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/spotify.gpg] http://repository.spotify.com stable non-free"
    filename: spotify
    state: present
  become: true
  failed_when: false

- name: Refresh apt cache after adding repositories
  ansible.builtin.apt:
    update_cache: true
  become: true

- name: Install desktop applications via apt (best effort)
  ansible.builtin.apt:
    name: "{{ item }}"
    state: present
  loop:
    - code
    - google-chrome-stable
    - slack-desktop
    - spotify-client
  loop_control:
    label: "{{ item }}"
  register: desktop_pkg_results
  failed_when: false
  become: true

- name: Track desktop app install results
  ansible.builtin.set_fact:
    install_success: "{{ (install_success | default([], true))
      + (desktop_pkg_results.results | default([], true)
         | selectattr('rc','defined')
         | selectattr('rc','equalto',0)
         | map(attribute='item') | list) }}"
    install_failed: "{{ (install_failed | default([], true))
      + (desktop_pkg_results.results | default([], true)
         | selectattr('rc','defined')
         | rejectattr('rc','equalto',0)
         | map(attribute='item') | list) }}"

- name: Install Discord via vendor .deb (best effort)
  ansible.builtin.apt:
    deb: "https://discord.com/api/download?platform=linux&format=deb"
  register: discord_install
  failed_when: false
  become: true

- name: Track Discord install result
  ansible.builtin.set_fact:
    install_success: "{{ (install_success | default([])) + ((((discord_install.rc | default(1)) == 0) | ternary(['discord'], []))) }}"
    install_failed: "{{ (install_failed | default([])) + ((((discord_install.rc | default(1)) == 0) | ternary([], ['discord']))) }}"

- name: Install Bitwarden via vendor .deb (best effort)
  ansible.builtin.apt:
    deb: "https://vault.bitwarden.com/download/?app=desktop&platform=linux&variant=deb"
  register: bitwarden_install
  failed_when: false
  become: true

- name: Track Bitwarden install result
  ansible.builtin.set_fact:
    install_success: "{{ (install_success | default([])) + ((((bitwarden_install.rc | default(1)) == 0) | ternary(['bitwarden'], []))) }}"
    install_failed: "{{ (install_failed | default([])) + ((((bitwarden_install.rc | default(1)) == 0) | ternary([], ['bitwarden']))) }}"

- name: Ensure Nerd Font temp directory exists
  ansible.builtin.file:
    path: /tmp/nerd-fonts
    state: directory
    mode: '0755'
  failed_when: false

- name: Download Nerd Font archives (best effort)
  ansible.builtin.get_url:
    url: "https://github.com/ryanoasis/nerd-fonts/releases/download/{{ nerd_fonts_release }}/{{ item.archive }}"
    dest: "/tmp/nerd-fonts/{{ item.archive }}"
    mode: '0644'
  loop: "{{ nerd_fonts_to_install }}"
  register: nerd_font_downloads
  failed_when: false

- name: Ensure Nerd Font extract directories exist
  ansible.builtin.file:
    path: "/tmp/nerd-fonts/{{ item.name }}"
    state: directory
    mode: '0755'
  loop: "{{ nerd_fonts_to_install }}"
  failed_when: false

- name: Extract Nerd Font archives (best effort)
  ansible.builtin.unarchive:
    src: "/tmp/nerd-fonts/{{ item.archive }}"
    dest: "/tmp/nerd-fonts/{{ item.name }}"
    remote_src: true
  loop: "{{ nerd_fonts_to_install }}"
  register: nerd_font_unzip
  failed_when: false

- name: Collect Nerd Font TTF files
  ansible.builtin.find:
    paths: /tmp/nerd-fonts
    patterns: "*.ttf"
    recurse: true
  register: nerd_font_files
  failed_when: false

- name: Ensure system Nerd Font directory exists
  ansible.builtin.file:
    path: /usr/local/share/fonts/nerd-fonts
    state: directory
    mode: '0755'
  become: true
  failed_when: false

- name: Install Nerd Fonts (best effort)
  ansible.builtin.copy:
    src: "{{ item.path }}"
    dest: "/usr/local/share/fonts/nerd-fonts/{{ item.path | basename }}"
    mode: '0644'
    remote_src: true
  loop: "{{ nerd_font_files.files | default([]) }}"
  register: nerd_font_copy
  failed_when: false
  become: true

- name: Refresh font cache (best effort)
  ansible.builtin.command: fc-cache -f
  register: nerd_font_fccache
  failed_when: false

- name: Track Nerd Font install result
  ansible.builtin.set_fact:
    install_success: "{{ (install_success | default([]))
      + ((nerd_font_copy.results | default([]) | selectattr('failed','defined') | selectattr('failed') | list | length == 0
          and (nerd_font_files.files | default([]) | length > 0)) | ternary(['nerd fonts'], [])) }}"
    install_failed: "{{ (install_failed | default([]))
      + ((nerd_font_copy.results | default([]) | selectattr('failed','defined') | selectattr('failed') | list | length == 0
          and (nerd_font_files.files | default([]) | length > 0)) | ternary([], ['nerd fonts'])) }}"

- name: Install uv package manager
  ansible.builtin.shell: |
    curl -LsSf https://astral.sh/uv/install.sh | sh
  args:
    creates: "{{ ansible_env.HOME }}/.local/bin/uv"
  environment:
    UV_NO_MODIFY_PATH: "1"
  register: uv_install
  failed_when: false

- name: Install nvm
  ansible.builtin.shell: |
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
  args:
    creates: "{{ ansible_env.HOME }}/.nvm/nvm.sh"
  register: nvm_install
  failed_when: false

- name: Install bun runtime
  ansible.builtin.shell: |
    curl -fsSL https://bun.sh/install | bash
  args:
    creates: "{{ ansible_env.HOME }}/.bun/bin/bun"
  register: bun_install
  failed_when: false

- name: Ensure local bin directory exists
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.local/bin"
    state: directory
    mode: '0755'

- name: Install oh-my-posh (official script, user scope)
  ansible.builtin.shell: |
    curl -s https://ohmyposh.dev/install.sh | bash -s -- -d "{{ ansible_env.HOME }}/.local/bin"
  args:
    creates: "{{ ansible_env.HOME }}/.local/bin/oh-my-posh"
  register: omp_install
  failed_when: false

- name: Track CLI/tool install results
  ansible.builtin.set_fact:
    install_success: "{{ (install_success | default([]))
      + (((uv_install.rc | default(1)) == 0) | ternary(['uv'], []))
      + (((nvm_install.rc | default(1)) == 0) | ternary(['nvm'], []))
      + (((bun_install.rc | default(1)) == 0) | ternary(['bun'], []))
      + (((omp_install.rc | default(1)) == 0) | ternary(['oh-my-posh'], [])) }}"
    install_failed: "{{ (install_failed | default([]))
      + (((uv_install.rc | default(1)) == 0) | ternary([], ['uv']))
      + (((nvm_install.rc | default(1)) == 0) | ternary([], ['nvm']))
      + (((bun_install.rc | default(1)) == 0) | ternary([], ['bun']))
      + (((omp_install.rc | default(1)) == 0) | ternary([], ['oh-my-posh'])) }}"

- name: Ensure Chrome policies directory exists
  ansible.builtin.file:
    path: /etc/opt/chrome/policies/managed
    state: directory
    mode: '0755'
  become: true

- name: Configure Chrome extensions
  ansible.builtin.copy:
    dest: /etc/opt/chrome/policies/managed/extensions.json
    content: |
      {
        "ExtensionInstallForcelist": {{ chrome_extensions | to_json }}
      }
    mode: '0644'
  become: true

- name: Schedule weekly system updates (Saturday at 20:00)
  ansible.builtin.cron:
    name: "Weekly System Updates"
    minute: "0"
    hour: "20"
    weekday: "6"
    job: "apt-get update && apt-get upgrade -y && snap refresh"
    user: root
  become: true
  failed_when: false

- name: Installation summary
  ansible.builtin.debug:
    msg:
      - "Successful installs: {{ install_success | unique }}"
      - "Failed installs: {{ install_failed | unique }}"

- name: Configure GNOME Terminal profile
  ansible.builtin.shell: |
    # Get default profile ID
    profile_id=$(gsettings get org.gnome.Terminal.ProfilesList default | tr -d "'")
    # Set colors and font
    dconf write /org/gnome/terminal/legacy/profiles:/:$profile_id/font "'DroidSansM Nerd Font Mono 18'"
    dconf write /org/gnome/terminal/legacy/profiles:/:$profile_id/background-color "'#2E003E'"
    dconf write /org/gnome/terminal/legacy/profiles:/:$profile_id/foreground-color "'#EAE0C8'"
    dconf write /org/gnome/terminal/legacy/profiles:/:$profile_id/use-theme-colors "false"
    dconf write /org/gnome/terminal/legacy/profiles:/:$profile_id/use-transparent-background "true"
    dconf write /org/gnome/terminal/legacy/profiles:/:$profile_id/background-transparency-percent "10"
  ignore_errors: true
  args:
    executable: /bin/bash

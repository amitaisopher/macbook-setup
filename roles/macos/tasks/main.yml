---
- name: Check if Homebrew exists in common locations
  ansible.builtin.stat:
    path: "{{ item }}"
  register: homebrew_stat
  loop:
    - /opt/homebrew/bin/brew
    - /usr/local/bin/brew

- name: Record Homebrew installation state
  ansible.builtin.set_fact:
    brew_is_installed: "{{ homebrew_stat.results | selectattr('stat.exists') | list | length > 0 }}"

- name: Install Homebrew when missing
  ansible.builtin.shell: |
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  args:
    creates: /opt/homebrew/bin/brew
  when: not brew_is_installed

- name: Ensure requested taps are present
  community.general.homebrew_tap:
    name: "{{ item }}"
    state: present
  loop: "{{ homebrew_taps }}"

- name: Install Homebrew formulas
  community.general.homebrew:
    name: "{{ item }}"
    state: present
    update_homebrew: true
  loop: "{{ homebrew_packages }}"

- name: Install Homebrew casks (best effort)
  community.general.homebrew_cask:
    name: "{{ item }}"
    state: present
  loop: "{{ homebrew_casks }}"
  register: cask_install
  failed_when: false
  ignore_errors: true
  loop_control:
    label: "{{ item }}"

- name: Warn about failed cask installs
  ansible.builtin.debug:
    msg: "Some casks failed to install: {{ (cask_install.results | selectattr('failed', 'defined') | selectattr('failed')) | map(attribute='item') | list }}"
  when: cask_install is defined and (cask_install.results | selectattr('failed', 'defined') | selectattr('failed') | list)

- name: Install Nerd Fonts
  community.general.homebrew_cask:
    name: "{{ item }}"
    state: present
  loop: "{{ nerd_fonts }}"

- name: Configure Chrome ExtensionInstallForcelist
  ansible.builtin.shell: |
    defaults write com.google.Chrome ExtensionInstallForcelist -array {{ chrome_extensions | map('quote') | join(' ') }}
  changed_when: false

- name: Schedule weekly Homebrew updates (Saturday at 20:00)
  ansible.builtin.cron:
    name: "Weekly Homebrew Updates"
    minute: "0"
    hour: "20"
    weekday: "6"
    job: "/opt/homebrew/bin/brew update && /opt/homebrew/bin/brew upgrade && /opt/homebrew/bin/brew upgrade --cask"
    user: "{{ ansible_user_id }}"

- name: Schedule weekly MacOS updates (Saturday at 20:00)
  ansible.builtin.cron:
    name: "Weekly MacOS Updates"
    minute: "0"
    hour: "20"
    weekday: "6"
    job: "softwareupdate -ia"
    user: root
    become: true

- name: Configure Terminal.app appearance
  ansible.builtin.shell: |
    osascript -e 'tell application "Terminal"
      set defaultSettings to default settings
      set font name of defaultSettings to "DroidSansM Nerd Font Mono"
      set font size of defaultSettings to 18
      set background color of defaultSettings to {11776, 0, 15872}
      set normal text color of defaultSettings to {60160, 57600, 51200}
      set cursor color of defaultSettings to {60160, 57600, 51200}
    end tell'
  ignore_errors: true

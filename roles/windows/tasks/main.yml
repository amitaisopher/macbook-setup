---
- name: Ensure Chocolatey is installed
  ansible.windows.win_shell: |
    Set-ExecutionPolicy Bypass -Scope Process -Force
    [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::Tls12
    if (-not (Test-Path "$env:ProgramData\chocolatey\bin\choco.exe")) {
      Invoke-Expression ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
    }
  args:
    creates: C:\\ProgramData\\chocolatey\\bin\\choco.exe

- name: Install core Chocolatey packages
  chocolatey.chocolatey.win_chocolatey:
    name: "{{ item }}"
    state: present
    ignore_checksums: true
  loop: "{{ choco_strict_packages }}"

- name: Install best-effort Chocolatey packages
  chocolatey.chocolatey.win_chocolatey:
    name: "{{ item }}"
    state: present
    ignore_checksums: true
  loop: "{{ choco_best_effort_packages }}"
  ignore_errors: true
  register: choco_optional

- name: Warn about missing Chocolatey packages
  ansible.builtin.debug:
    msg: "Packages not available in Chocolatey: {{ (choco_optional.results | selectattr('failed', 'defined') | selectattr('failed')) | map(attribute='item') | list }}"
  when: choco_optional is defined and (choco_optional.results | selectattr('failed', 'defined') | selectattr('failed') | list)

- name: Download Nerd Font archives
  ansible.windows.win_get_url:
    url: "https://github.com/ryanoasis/nerd-fonts/releases/download/{{ nerd_fonts_release }}/{{ item.archive }}"
    dest: "{{ ansible_env.TEMP }}\\{{ item.archive }}"
  loop: "{{ nerd_fonts_to_install }}"

- name: Extract Nerd Font archives
  community.windows.win_unzip:
    src: "{{ ansible_env.TEMP }}\\{{ item.archive }}"
    dest: "{{ ansible_env.TEMP }}\\fonts-{{ item.name }}"
    overwrite: true
  loop: "{{ nerd_fonts_to_install }}"

- name: Install Nerd Fonts into Windows Fonts directory
  ansible.windows.win_shell: |
    $source = "{{ ansible_env.TEMP }}\\fonts-{{ item.name }}"
    Get-ChildItem -Path $source -Filter *.ttf -Recurse | ForEach-Object {
      Copy-Item $_.FullName -Destination "$env:WINDIR\\Fonts" -Force
    }
      Copy-Item $_.FullName -Destination "$env:WINDIR\\Fonts" -Force
    }
  loop: "{{ nerd_fonts_to_install }}"

- name: Configure Chrome ExtensionInstallForcelist
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Google\Chrome\ExtensionInstallForcelist
    name: "{{ idx + 1 }}"
    data: "{{ item }}"
    type: string
    state: present
  loop: "{{ chrome_extensions }}"
  loop_control:
    index_var: idx

- name: Check npm availability for GitHub Copilot CLI
  ansible.windows.win_shell: npm --version
  register: copilot_npm_check
  changed_when: false
  failed_when: false

- name: Abort when npm is unavailable for GitHub Copilot CLI
  ansible.builtin.fail:
    msg: "GitHub Copilot CLI requires npm (see https://docs.github.com/en/copilot/how-tos/set-up/install-copilot-cli). Install Node.js/npm and rerun the playbook."
  when: copilot_npm_check.rc != 0

- name: Check Node.js major version for npm-installed tools
  ansible.windows.win_shell: |
    $version = node --version
    if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
    $major = $version.TrimStart('v').Split('.')[0]
    Write-Output $major
  register: node_major_version
  changed_when: false
  failed_when: false
  when: copilot_npm_check.rc == 0

- name: Abort when Node.js version cannot be detected
  ansible.builtin.fail:
    msg: "Unable to detect Node.js version. Please ensure Node.js 20+ is installed."
  when:
    - copilot_npm_check.rc == 0
    - node_major_version.rc != 0

- name: Enforce Node.js >= 20 for npm-installed tools
  ansible.builtin.fail:
    msg: "Node.js 20+ is required for npm-based tools (GitHub Copilot CLI, Google Gemini CLI)."
  when:
    - copilot_npm_check.rc == 0
    - node_major_version.rc == 0
    - (node_major_version.stdout | int) < 20

- name: Check for existing GitHub Copilot CLI installation
  ansible.windows.win_shell: github-copilot-cli --version
  register: copilot_cli_check
  changed_when: false
  failed_when: false

- name: Install GitHub Copilot CLI via npm
  ansible.windows.win_shell: npm install -g @github/copilot
  environment:
    npm_config_yes: "true"
  when:
    - copilot_cli_check.rc != 0
    - copilot_npm_check.rc == 0

- name: Verify GitHub Copilot CLI installation
  ansible.windows.win_shell: github-copilot-cli --version
  register: copilot_cli_verify
  changed_when: false
  failed_when: copilot_cli_verify.rc != 0

- name: Check for existing Google Gemini CLI installation
  ansible.windows.win_shell: gemini --version
  register: gemini_cli_check
  changed_when: false
  failed_when: false

- name: Install Google Gemini CLI via npm
  ansible.windows.win_shell: npm install -g @google/gemini-cli
  environment:
    npm_config_yes: "true"
  when:
    - copilot_npm_check.rc == 0
    - node_major_version.rc == 0
    - (node_major_version.stdout | int) >= 20
    - gemini_cli_check.rc != 0

- name: Verify Google Gemini CLI installation
  ansible.windows.win_shell: gemini --version
  register: gemini_cli_verify
  changed_when: false
  failed_when: gemini_cli_verify.rc != 0

- name: Check for existing Claude Code installation
  ansible.windows.win_shell: claude --version
  register: claude_check
  changed_when: false
  failed_when: false

- name: Install Claude Code via official installer script
  ansible.windows.win_shell: |
    $temp = Join-Path $env:TEMP "claude-install.cmd"
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
    Invoke-WebRequest -Uri "{{ claude_install_cmd_url }}" -OutFile $temp -UseBasicParsing
    cmd.exe /c $temp
    Remove-Item $temp -Force
  when: claude_check.rc != 0

- name: Verify Claude Code installation
  ansible.windows.win_shell: claude --version
  register: claude_verify
  changed_when: false
  failed_when: claude_verify.rc != 0

# Windows scheduled updates task intentionally disabled (win_scheduled_task unavailable)
